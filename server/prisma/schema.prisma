// This is your Prisma schema file for Teen Sunday School
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ORGANIZATIONS & USERS
// ============================================================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  timezone  String   @default("America/New_York")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users             User[]
  groups            Group[]
  integrations      ExternalIntegration[]
  lessons           Lesson[]
  aiFilterConfigs   AIFilterConfig[]
  comparativeThemes ComparativeTheme[]
  parables     Parable[]
  translationComparisonNotes TranslationComparisonNote[]
  personalGoals PersonalGoal[]

  @@index([slug])
}

model User {
  id             String  @id @default(cuid())
  email          String  @unique
  passwordHash   String
  firstName      String
  lastName       String
  role           Role    @default(MEMBER)
  organizationId String
  isActive       Boolean @default(true)

  // External system IDs (for syncing)
  externalId   String? // Planning Center person ID
  externalData Json? // Additional metadata from external system

  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  organization          Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  groupMemberships      GroupMember[]
  refreshTokens         RefreshToken[]
  notificationPreference NotificationPreference?
  notifications         Notification[]
  organization     Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  groupMemberships GroupMember[]
  refreshTokens    RefreshToken[]
  personalGoals    PersonalGoal[]
  goalProgress     GoalProgress[]

  @@index([email])
  @@index([organizationId])
  @@index([externalId])
}

enum Role {
  SUPER_ADMIN // Platform admin
  ORG_ADMIN // Organization administrator
  TEACHER // Can create/edit lessons
  MEMBER // Regular member/student
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

// ============================================================================
// GROUPS
// ============================================================================

model Group {
  id             String  @id @default(cuid())
  name           String
  description    String?
  organizationId String

  // For syncing with external systems
  externalId   String? // Planning Center list ID
  externalData Json? // Metadata from external system

  ageMin Int?
  ageMax Int?
  grade  String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members      GroupMember[]
  mappings     ExternalGroupMapping[]
  lessons      LessonGroup[]

  @@index([organizationId])
  @@index([externalId])
}

model GroupMember {
  id        String   @id @default(cuid())
  userId    String
  groupId   String
  role      String   @default("member") // "leader", "assistant", "member"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId])
  @@index([userId])
  @@index([groupId])
}

// ============================================================================
// EXTERNAL INTEGRATIONS
// ============================================================================

model ExternalIntegration {
  id             String              @id @default(cuid())
  organizationId String
  provider       IntegrationProvider
  status         IntegrationStatus   @default(INACTIVE)

  // Encrypted credentials (AES-256-GCM)
  credentialsEncrypted String @db.Text
  credentialsIV        String // Initialization vector for encryption
  credentialsTag       String // Authentication tag for encryption

  // OAuth specific fields
  accessToken    String?   @db.Text
  refreshToken   String?   @db.Text
  tokenExpiresAt DateTime?

  // API configuration
  apiBaseUrl String?
  apiVersion String?

  // Sync configuration
  syncEnabled    Boolean       @default(false)
  syncFrequency  SyncFrequency @default(DAILY)
  lastSyncAt     DateTime?
  lastSyncStatus SyncStatus?
  nextSyncAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization  Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  groupMappings ExternalGroupMapping[]
  syncLogs      SyncLog[]

  @@index([organizationId])
  @@index([provider])
  @@index([status])
}

enum IntegrationProvider {
  PLANNING_CENTER
  CCB // Church Community Builder
  ELVANTO
  BREEZE
  FELLOWSHIP_ONE
  ROCK_RMS
}

enum IntegrationStatus {
  ACTIVE
  INACTIVE
  ERROR
  PENDING
  EXPIRED // OAuth token expired
}

enum SyncFrequency {
  HOURLY
  DAILY
  WEEKLY
  MANUAL // Only manual syncs
}

enum SyncStatus {
  SUCCESS
  ERROR
  PARTIAL // Some data synced, some failed
}

// ============================================================================
// GROUP MAPPINGS
// ============================================================================

model ExternalGroupMapping {
  id                String  @id @default(cuid())
  integrationId     String
  externalGroupId   String // ID from external system (e.g., Planning Center list ID)
  externalGroupName String
  externalGroupType String? // Type in external system
  groupId           String? // NULL if not yet mapped

  // Sync settings for this mapping
  syncMembers Boolean @default(true)
  syncLeaders Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  integration ExternalIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  group       Group?              @relation(fields: [groupId], references: [id], onDelete: SetNull)

  @@unique([integrationId, externalGroupId])
  @@index([integrationId])
  @@index([groupId])
}

// ============================================================================
// SYNC LOGS & ANALYTICS
// ============================================================================

model SyncLog {
  id            String     @id @default(cuid())
  integrationId String
  status        SyncStatus
  startedAt     DateTime   @default(now())
  completedAt   DateTime?
  durationMs    Int? // Duration in milliseconds

  // Metrics
  peopleAdded   Int @default(0)
  peopleUpdated Int @default(0)
  peopleRemoved Int @default(0)
  groupsAdded   Int @default(0)
  groupsUpdated Int @default(0)
  groupsSkipped Int @default(0)

  // Error tracking
  errorMessage String? @db.Text
  errorCode    String?
  errorDetails Json?

  // Additional metadata
  metadata Json?

  integration ExternalIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@index([startedAt])
  @@index([status])
}

// ============================================================================
// LESSONS (Migrated from localStorage)
// ============================================================================

model Lesson {
  id             String @id @default(cuid())
  organizationId String

  // Lesson metadata
  title        String
  quarter      Int
  unit         Int
  lessonNumber Int
  scripture    String

  // Content
  content Json // Full lesson content as JSON
  slides  Json? // Slide data
  games   Json? // Game configurations

  // Sharing & visibility
  isPublic   Boolean @default(false)
  isTemplate Boolean @default(false)

  createdBy String? // User ID
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  groups       LessonGroup[]

  @@unique([organizationId, quarter, unit, lessonNumber])
  @@index([organizationId])
  @@index([isPublic])
}

model LessonGroup {
  id        String   @id @default(cuid())
  lessonId  String
  groupId   String
  createdAt DateTime @default(now())

  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  group  Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)
  coverageRecords CurriculumCoverage[]

  @@unique([lessonId, groupId])
  @@index([lessonId])
  @@index([groupId])
}

// ============================================================================
// CURRICULUM COVERAGE REPORTING
// ============================================================================

model CurriculumCoverage {
  id             String   @id @default(cuid())
  organizationId String
  lessonGroupId  String   // Links to LessonGroup
  lessonId       String   // Denormalized for easier queries
  groupId        String   // Denormalized for easier queries

  // Coverage details
  status         CoverageStatus @default(PLANNED)
  completedAt    DateTime?
  scheduledDate  DateTime?

  // Progress tracking
  attendeeCount  Int?     // How many attended
  notes          String?  @db.Text

  // Metadata
  markedBy       String?  // User ID who marked as complete
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  lessonGroup LessonGroup @relation(fields: [lessonGroupId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([lessonGroupId])
  @@index([lessonId])
  @@index([groupId])
  @@index([status])
  @@index([completedAt])
}

enum CoverageStatus {
  PLANNED       // Scheduled but not yet taught
  IN_PROGRESS   // Currently teaching
  COMPLETED     // Finished teaching
  SKIPPED       // Intentionally skipped
}

model CoverageReportMetric {
  id             String   @id @default(cuid())
  organizationId String

  // Report details
  reportType     String   // "quarter", "unit", "group", "overview"
  reportParams   Json?    // Parameters used to generate report

  // User engagement
  userId         String?  // User who viewed report
  viewedAt       DateTime @default(now())
  timeSpentMs    Int?     // Time spent viewing in milliseconds

  // Export tracking
  exportFormat   String?  // "pdf", "csv", "json" if exported
  exportedAt     DateTime?

  @@index([organizationId])
  @@index([userId])
  @@index([viewedAt])
  @@index([reportType])
}

// ============================================================================
// AI CONTENT FILTERS
// ============================================================================

model AIFilterConfig {
  id             String  @id @default(cuid())
  organizationId String? // NULL = global/default config

  // Filter categories and their handling rules
  filterRules Json // { "relationships_sexuality": "REDIRECT", "mental_health": "GUIDANCE", ... }

  // Additional settings
  customKeywords  Json? // Custom keywords to filter: { "block": [...], "monitor": [...] }
  redirectMessage String? @db.Text // Custom message when redirecting to leader

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization?    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  metrics      AIFilterMetric[]

  @@unique([organizationId]) // One config per org (plus one global)
  @@index([organizationId])
  @@index([isActive])
}

enum FilterCategory {
  RELATIONSHIPS_SEXUALITY
  MENTAL_HEALTH
  CONTROVERSIAL_DOCTRINE
  VIOLENCE_ABUSE
  SUBSTANCE_USE
  POLITICS
  FAMILY_ISSUES
  DEATH_GRIEF
  DOUBTS_FAITH
  PEER_PRESSURE
  CUSTOM
}

enum FilterAction {
  REDIRECT // Redirect to leader
  GUIDANCE // Provide high-level guidance only
  BLOCK // Block completely with generic message
  MONITOR // Allow but log for review
}

model AIFilterMetric {
  id             String  @id @default(cuid())
  filterId       String
  organizationId String?

  // Query details
  query            String         @db.Text
  detectedCategory FilterCategory
  actionTaken      FilterAction

  // Context
  userId      String? // User who made the query
  groupId     String? // Group context if applicable
  featureName String? // Which AI feature triggered the filter

  // Leader follow-up tracking
  leaderNotified Boolean   @default(false)
  leaderResponse String?   @db.Text
  resolvedAt     DateTime?

  createdAt DateTime @default(now())

  filter AIFilterConfig @relation(fields: [filterId], references: [id], onDelete: Cascade)

  @@index([filterId])
  @@index([organizationId])
  @@index([createdAt])
  @@index([detectedCategory])
  @@index([actionTaken])
  @@index([userId])
}

// ============================================================================
// COMPARATIVE THEME VIEW (OT vs NT)
// ============================================================================

model ComparativeTheme {
  id             String @id @default(cuid())
  organizationId String

  // Theme metadata
  themeName   String
  description String? @db.Text
  category    String? // e.g., "covenant", "sacrifice", "grace", "justice"

  // Old Testament passages
  otPassages Json // Array of {ref: string, text?: string, notes?: string}

  // New Testament passages
  ntPassages Json // Array of {ref: string, text?: string, notes?: string}

  // Comparative analysis
  themeNotes Json? // {summary: string, connections: string[], keyInsights: string[]}

  // Visibility
  isPublic Boolean @default(false)

  // Authorship
  createdBy String? // User ID
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  metrics      ThemeMetric[]

  @@index([organizationId])
  @@index([category])
  @@index([themeName])
}

model ThemeMetric {
  id             String @id @default(cuid())
  themeId        String
  organizationId String

  // Tracking
  viewCount    Int      @default(0)
  lastViewedAt DateTime @default(now())

  // User engagement
  userId         String? // User who viewed
  featureContext String? // Where it was accessed (e.g., "topical_index", "passage_link", "direct")
  timeSpentMs    Int? // Time spent viewing in milliseconds

  // Lesson usage tracking
  usedInLesson Boolean @default(false)
  lessonId     String?

  createdAt DateTime @default(now())

  theme ComparativeTheme @relation(fields: [themeId], references: [id], onDelete: Cascade)

  @@index([themeId])
  @@index([organizationId])
  @@index([createdAt])
  @@index([userId])
}

// ============================================================================
// NOTIFICATION SYSTEM
// ============================================================================

model NotificationPreference {
  id     String @id @default(cuid())
  userId String @unique

  // Email notification settings
  emailEnabled          Boolean @default(true)
  emailLessonReminders  Boolean @default(true)
  emailEventReminders   Boolean @default(true)
  emailAnnouncements    Boolean @default(true)
  emailGroupUpdates     Boolean @default(true)
  emailDigest           Boolean @default(false)  // Daily/weekly digest
  emailDigestFrequency  DigestFrequency @default(WEEKLY)

  // In-app notification settings
  inAppEnabled          Boolean @default(true)
  inAppLessonReminders  Boolean @default(true)
  inAppEventReminders   Boolean @default(true)
  inAppAnnouncements    Boolean @default(true)
  inAppGroupUpdates     Boolean @default(true)

  // Scheduling preferences
  quietHoursEnabled     Boolean @default(false)
  quietHoursStart       String? // Time in HH:MM format (e.g., "22:00")
  quietHoursEnd         String? // Time in HH:MM format (e.g., "08:00")
  quietHoursTimezone    String  @default("America/New_York")

  // Days of week preferences (ISO 8601: 1=Monday, 7=Sunday)
  preferredDays         Json?   // Array of day numbers [1,2,3,4,5] for Mon-Fri

  // Notification timing
  lessonReminderDays    Int     @default(2)  // Days before lesson to send reminder
  lessonReminderTime    String  @default("18:00") // Time to send lesson reminders (HH:MM)
  eventReminderHours    Int     @default(24) // Hours before event to send reminder

  // Batch settings
  batchNotifications    Boolean @default(false) // Batch multiple notifications together
  maxNotificationsPerDay Int    @default(10)   // Maximum notifications per day (0 = unlimited)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum DigestFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
}

model Notification {
// DAILY GRATITUDE LOG
// ============================================================================

model GratitudeEntry {
  id             String   @id @default(cuid())
  userId         String
  organizationId String

  // Notification content
  type           NotificationType
  title          String
  message        String   @db.Text
  actionUrl      String?  // Deep link or URL for the notification action

  // Delivery settings
  deliveryMethod NotificationDeliveryMethod @default(BOTH)
  priority       NotificationPriority @default(NORMAL)

  // Scheduling
  scheduledFor   DateTime?  // When to send (NULL = send immediately)
  sentAt         DateTime?
  readAt         DateTime?

  // Status tracking
  status         NotificationStatus @default(PENDING)
  deliveryStatus Json?      // { email: "sent", inApp: "delivered" } with timestamps

  // Error handling
  failureReason  String?    @db.Text
  retryCount     Int        @default(0)
  maxRetries     Int        @default(3)

  // Related entities
  groupId        String?
  lessonId       String?
  eventId        String?

  // Metadata
  metadata       Json?      // Additional context data

  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
  @@index([status])
  @@index([type])
  @@index([scheduledFor])
  @@index([sentAt])
}

enum NotificationType {
  LESSON_REMINDER       // Upcoming lesson reminder
  EVENT_REMINDER        // Event reminder
  ANNOUNCEMENT          // General announcement
  GROUP_UPDATE          // Group membership or activity update
  LESSON_ASSIGNED       // New lesson assigned to group
  COMMENT_REPLY         // Someone replied to your comment
  MENTION               // Someone mentioned you
  SYNC_COMPLETE         // Integration sync completed
  SYNC_ERROR            // Integration sync failed
  CUSTOM                // Custom notification
}

enum NotificationDeliveryMethod {
  EMAIL
  IN_APP
  BOTH
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum NotificationStatus {
  PENDING           // Not yet sent
  SCHEDULED         // Scheduled for future delivery
  SENDING           // Currently being sent
  SENT              // Successfully sent
  DELIVERED         // Confirmed delivered (for in-app)
  READ              // User has read the notification
  FAILED            // Failed to send
  CANCELLED         // Cancelled before sending
}

model NotificationSchedule {
  id             String   @id @default(cuid())
  organizationId String
  groupId        String?  // NULL = applies to all groups in org

  // Schedule metadata
  name           String
  description    String?  @db.Text

  // Notification template
  notificationType NotificationType
  title          String
  message        String   @db.Text
  actionUrl      String?

  // Recurrence settings
  frequency      ScheduleFrequency
  dayOfWeek      Int?     // 1-7 (Monday-Sunday) for WEEKLY
  dayOfMonth     Int?     // 1-31 for MONTHLY
  timeOfDay      String   // HH:MM format (e.g., "18:00")
  timezone       String   @default("America/New_York")

  // Offset settings
  offsetDays     Int      @default(0)  // Days before/after the trigger event
  offsetHours    Int      @default(0)  // Additional hours offset

  // Targeting
  targetRoles    Json?    // Array of roles to notify ["TEACHER", "ORG_ADMIN"]
  targetUserIds  Json?    // Specific user IDs to notify

  // Status
  isActive       Boolean  @default(true)
  lastRunAt      DateTime?
  nextRunAt      DateTime?
// SONG / LYRICS INTEGRATION
// ============================================================================

model SongRef {
  id             String   @id @default(cuid())
  organizationId String?  // NULL = globally available song

  // Song metadata
  title          String
  artist         String
  linkUrl        String?  @db.Text // Link to song (YouTube, Spotify, etc.)
  themeTags      String[] // Array of theme tags (worship, faith, grace, etc.)

  // Bible references this song relates to
  relatedVerses  Json     // Array of verse references: ["JHN.3.16", "ROM.8.28", ...]

  // For match game (short snippet or paraphrase, max 10 words)
  gameSnippet    String?  @db.Text
  gameTheme      String?  // Primary theme for matching

  // Admin curation
  isApproved     Boolean  @default(false)
  curatedBy      String?  // Admin user ID who approved

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  playlistItems  SongPlaylistItem[]
  metrics        SongMetric[]

  @@index([organizationId])
  @@index([isApproved])
  @@index([themeTags])
}

model SongPlaylist {
  id             String   @id @default(cuid())
  organizationId String
  userId         String   // Leader who created the playlist

  // Playlist metadata
  name           String
  description    String?  @db.Text
  lessonId       String?  // Optional link to a specific lesson

  isPublic       Boolean  @default(false) // Share with other leaders
// SUBSTITUTE TEACHER ASSIGNMENTS
// ============================================================================

model SubstituteAssignment {
  id             String   @id @default(cuid())
  organizationId String

  // Assignment details
  substituteId   String   // User ID of the substitute teacher
  groupId        String   // Group they're substituting for
  scheduledDate  DateTime // Date of the class
  lessonId       String?  // Pre-assigned lesson (optional)

  // Regular teacher info (for context)
  regularTeacherId String? // User ID of regular teacher

  // Quick-start materials
  notes          String?  @db.Text // Special instructions from regular teacher
  emergencyContacts Json? // Array of {name: string, phone: string, role: string}
  customMaterials   Json? // Links to additional resources

  // Status tracking
  status         SubstituteStatus @default(SCHEDULED)
  acceptedAt     DateTime?
  completedAt    DateTime?

  // Feedback
  substituteNotes String? @db.Text // Notes from substitute after class

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
  @@index([groupId])
  @@index([isActive])
  @@index([nextRunAt])
}

enum ScheduleFrequency {
  ONCE          // One-time scheduled notification
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  BEFORE_LESSON // Triggered before lessons (uses offsetDays)
  BEFORE_EVENT  // Triggered before events (uses offsetHours)
}

// ============================================================================
// BIBLE CHARACTER GUESS GAME METRICS
// ============================================================================

model CharacterGuessAttempt {
  id             String   @id @default(cuid())
  userId         String?  // Optional - can track anonymous plays
  organizationId String?
  lessonId       String?

  // Game details
  characterId    String   // Character ID from lesson JSON
  characterName  String   // Character name for easier queries
  difficulty     String   // easy, medium, hard

  // Attempt details
  hintsRevealed  Int      // Number of hints revealed before guess
  isCorrect      Boolean  // Whether they guessed correctly
  attempts       Int      // Number of attempts made
  timeSpentMs    Int?     // Time spent on this character (optional)

  // Context
  mode           String   @default("solo") // solo or group
  groupId        String?  // If played in group mode

  createdAt      DateTime @default(now())

  @@index([userId])
  @@index([organizationId])
  @@index([characterId])
  @@index([lessonId])
  @@index([createdAt])
  @@index([isCorrect])
}

model CharacterGuessMetric {
  id             String   @id @default(cuid())
  characterId    String   // Character ID from lesson JSON
  characterName  String   // Character name
  organizationId String?
  lessonId       String?

  // Aggregated metrics
  totalPlays     Int      @default(0)
  totalCorrect   Int      @default(0)
  totalIncorrect Int      @default(0)
  successRate    Float    @default(0) // Calculated: totalCorrect / totalPlays

  // Hint usage statistics
  avgHintsUsed   Float    @default(0)

  // Popularity
  popularityScore Float   @default(0) // Weighted score based on plays and success

  lastPlayedAt   DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([characterId, organizationId, lessonId])
  @@index([organizationId])
  @@index([lessonId])
  @@index([popularityScore])
  @@index([successRate])
}

// ============================================================================
// WEEKLY WORD (Original Language Feature)
// ============================================================================

model WeeklyWord {
  id             String   @id @default(cuid())
  organizationId String?  // NULL = shared across all organizations

  // Word details
  lemma          String   // Original word in Greek/Hebrew script
  language       Language // GREEK or HEBREW
  transliteration String  // Romanized version for pronunciation
  gloss          String   // English meaning/translation

  // Content
  blurb          String   @db.Text // Short explanation/teaching
  verseRefs      Json     // Array of verse references: ["John 3:16", "Romans 8:28"]
  verseTexts     Json?    // Optional: cached verse texts for performance

  // Scheduling
  weekStart      DateTime // Start date of the week this word is featured
  weekEnd        DateTime // End date (typically weekStart + 7 days)

  // Metadata
  isFeatured     Boolean  @default(false) // Currently featured word
  isActive       Boolean  @default(true)  // Archived words set to false

  createdBy      String?  // User ID of creator (admin)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  metrics        WeeklyWordMetric[]

  @@index([organizationId])
  @@index([weekStart])
  @@index([isFeatured])
  @@index([isActive])
}

enum Language {
  GREEK
  HEBREW
  ARAMAIC
}

model WeeklyWordMetric {
  id           String   @id @default(cuid())
  wordId       String
  userId       String?  // NULL = anonymous view

  // Interaction types
  eventType    WeeklyWordEventType
  verseRef     String?  // Which verse was clicked (if applicable)

  // Context
  viewSource   String?  // "today_page", "dashboard", "archive"
  sessionId    String?  // For tracking unique sessions

  createdAt    DateTime @default(now())

  word WeeklyWord @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@index([wordId])
  @@index([userId])
  @@index([createdAt])
  @@index([eventType])
}

enum WeeklyWordEventType {
  VIEW          // Card viewed
  VERSE_CLICK   // Clicked to read a verse
  SHARE         // Shared the word
  ARCHIVE_VIEW  // Viewed in archive
}

// ============================================================================
// INTERLINEAR VERSES
// ============================================================================

model InterlinearVerse {
  id        String   @id @default(cuid())
  verseRef  String   @unique // Verse reference (e.g., "JHN.3.16")

  // Interlinear data as JSON array
  // Each token contains: { original, transliteration, gloss, strongsNumber?, morphology? }
  tokensJson Json

  // Metadata
  language   String   @default("greek") // "greek" or "hebrew"
  translation String  @default("NA28")  // Source text (NA28, BHS, etc.)

  // Curation flags
  isKeyVerse Boolean  @default(false)  // Is this a curated key verse?
  category   String?                   // "salvation", "love", "faith", etc.

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  metrics    InterlinearMetric[]

  @@index([verseRef])
  @@index([isKeyVerse])
  @@index([category])
}

model InterlinearMetric {
  id        String   @id @default(cuid())
  verseId   String

  // Context
  organizationId String?
  userId         String?

  // Interaction details
  action         String   // "view", "word_click", "copy", etc.
  wordIndex      Int?     // Which word was clicked/interacted with

  // Metadata
  featureName    String?  // Where the interlinear was accessed from
  sessionId      String?  // Session tracking

  createdAt      DateTime @default(now())

  verse InterlinearVerse @relation(fields: [verseId], references: [id], onDelete: Cascade)

  @@index([verseId])
  @@index([organizationId])
  @@index([userId])
  @@index([createdAt])
  @@index([action])
  items          SongPlaylistItem[]

  @@index([organizationId])
  @@index([userId])
  @@index([lessonId])
}

model SongPlaylistItem {
  id          String   @id @default(cuid())
  playlistId  String
  songId      String
  orderIndex  Int      // Order in playlist
  notes       String?  @db.Text // Leader notes for this song

  createdAt   DateTime @default(now())

  playlist SongPlaylist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  song     SongRef      @relation(fields: [songId], references: [id], onDelete: Cascade)

  @@unique([playlistId, songId])
  @@index([playlistId])
  @@index([songId])
}

model SongMetric {
  id             String   @id @default(cuid())
  songId         String
  organizationId String?

  // Metric type
  metricType     SongMetricType

  // Context
  userId         String?  // User who interacted
  groupId        String?  // Group context if applicable
  passageRef     String?  // Bible passage being viewed (e.g., "JHN.3.16")

  createdAt      DateTime @default(now())

  song SongRef @relation(fields: [songId], references: [id], onDelete: Cascade)

  @@index([songId])
  @@index([organizationId])
  @@index([metricType])
  @@index([createdAt])
  @@index([userId])
}

enum SongMetricType {
  VIEW           // Song was viewed in related songs section
  LINK_CLICK     // External link was clicked
  GAME_PLAY      // Song was used in match game
  PLAYLIST_ADD   // Song was added to a playlist
// BIBLE REFERENCE GAME
// ============================================================================

model GuessReferenceQuestion {
  id              String   @id @default(cuid())
  verseReference  String   // e.g., "John 3:16"
  displayText     String   @db.Text // The verse text or paraphrase
  correctAnswer   String   // The correct reference
  distractorRefs  Json     // Array of distractor references, e.g., ["John 3:17", "Romans 3:16", "Genesis 1:1"]

  // Optional categorization
  book            String?  // Book name for filtering
  difficulty      String?  @default("medium") // "easy", "medium", "hard"
  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  attempts        GuessReferenceAttempt[]

  @@index([book])
  @@index([difficulty])
  @@index([isActive])
}

model GuessReferenceAttempt {
  id              String   @id @default(cuid())
  questionId      String
  userId          String?  // Optional - tracks logged-in users
  sessionId       String?  // For tracking anonymous sessions

  selectedAnswer  String   // The reference the user selected
  isCorrect       Boolean  // Whether they got it right
  timeToAnswerMs  Int?     // Time taken to answer in milliseconds

  // Game context
  gameMode        String?  // e.g., "random", "book:John", "plan:123"
  roundNumber     Int?     // Position in the game session

  createdAt       DateTime @default(now())

  question        GuessReferenceQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
  @@index([userId])
  @@index([sessionId])
  @@index([createdAt])
  // Content
  gratitudeText  String   @db.Text
  mood           String?  // Optional: happy, grateful, blessed, peaceful, joyful, etc.
  category       String?  // Optional: family, faith, health, friends, school, etc.

  // Tracking
  entryDate      DateTime // The date this entry is for (date-only, without time)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations would go here if User had a relation back
  // For now, userId is just a String reference

  @@unique([userId, entryDate]) // One entry per user per day
  @@index([userId])
  @@index([organizationId])
  @@index([entryDate])
  @@index([substituteId])
  @@index([groupId])
  @@index([scheduledDate])
  @@index([status])
}

enum SubstituteStatus {
  SCHEDULED     // Assignment created
  ACCEPTED      // Substitute confirmed
  IN_PROGRESS   // Class is happening
  COMPLETED     // Class finished
  CANCELLED     // Assignment cancelled
}

// Quick-access presets for substitute teachers
model QuickStartPreset {
  id             String   @id @default(cuid())
  organizationId String

  // Preset details
  name           String
  description    String?

  // Included resources
  includeSlides          Boolean @default(true)
  includeGames           Boolean @default(true)
  includeDiscussion      Boolean @default(true)
  includeScripture       Boolean @default(true)
  includeGroupRoster     Boolean @default(true)
  includeEmergencyInfo   Boolean @default(true)

  // Time-saving options
  autoLoadPresentation   Boolean @default(true)
  simplifiedView         Boolean @default(true) // Hide advanced features

  // Template materials for emergency use
  backupActivities       Json?   // Array of simple activities if lesson unavailable
  iceBreakers            Json?   // Quick icebreaker activities

  isDefault      Boolean @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
  @@index([isDefault])
// PARABLES EXPLORER
// ============================================================================

model Parable {
  id             String   @id @default(cuid())
  organizationId String

  // Parable metadata
  title          String
  reference      String   // e.g., "Matthew 13:3-8"
  category       String?  // e.g., "Kingdom of God", "Grace", "Judgment", "Faith"

  // Content
  parableText    String   @db.Text // The actual parable text
  interpretation String?  @db.Text // What the parable means/teaches
  historicalContext String? @db.Text // Historical and cultural background

  // Teaching points and application
  applicationPoints Json?  // Array of strings with practical applications
  keyTheme       String?  // Main theme or teaching

  // Related content
  crossReferences Json?   // Array of {ref: string, description?: string}
  relatedParables Json?   // Array of parable IDs or references
// TRANSLATION COMPARISON NOTES (Teen-Friendly)
// ============================================================================

model TranslationComparisonNote {
  id             String   @id @default(cuid())
  organizationId String

  // Note metadata
  title          String
  description    String?  @db.Text
  passageRef     String   // Primary passage reference (e.g., "John 3:16")

  // Translation data
  // Array of {code: "NIV", name: "New International Version", text: "passage text", focus?: "key phrase"}
  translations   Json

  // Comparison points (teen-friendly explanations)
  // Array of {aspect: "Word Choice", difference: "NIV uses 'love' while KJV uses 'loved'", teenExplanation: "Both mean the same thing..."}
  comparisonPoints Json

  // Additional teen-friendly content
  teenSummary    String?  @db.Text  // Simple summary for teens
  whyItMatters   String?  @db.Text  // Why this comparison is important
  keyTakeaway    String?  @db.Text  // Main point for teens to remember

  // Categorization
  category       String?  // e.g., "word-choice", "context", "cultural", "theological"
  difficulty     String?  // "beginner", "intermediate", "advanced"
  tags           Json?    // Array of tags for filtering

  // Visibility
  isPublic       Boolean  @default(false)

  // Authorship
  createdBy      String?  // User ID
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  metrics      ParableMetric[]

  @@index([organizationId])
  @@index([category])
  @@index([title])
  @@index([reference])
}

model ParableMetric {
  id             String   @id @default(cuid())
  parableId      String
  metrics      ComparisonNoteMetric[]

  @@index([organizationId])
  @@index([passageRef])
  @@index([category])
  @@index([difficulty])
}

model ComparisonNoteMetric {
  id             String   @id @default(cuid())
  noteId         String
  organizationId String

  // Tracking
  viewCount      Int      @default(0)
  lastViewedAt   DateTime @default(now())

  // User engagement
  userId         String?  // User who viewed
  featureContext String?  // Where it was accessed (e.g., "explorer", "lesson", "search")
  featureContext String?  // Where it was accessed (e.g., "browse", "passage_lookup", "search")
  timeSpentMs    Int?     // Time spent viewing in milliseconds

  // Lesson usage tracking
  usedInLesson   Boolean  @default(false)
  lessonId       String?

  createdAt      DateTime @default(now())

  parable Parable @relation(fields: [parableId], references: [id], onDelete: Cascade)

  @@index([parableId])
  // User feedback (optional)
  wasHelpful     Boolean?  // Did the teen find this helpful?

  createdAt      DateTime @default(now())

  note TranslationComparisonNote @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@index([noteId])
// DOCTRINE OVERVIEW CARDS
// ============================================================================

model DoctrineCard {
  id String @id @default(cuid())

  // Core doctrine information
  title           String // e.g., "God the Father", "Salvation", "The Trinity"
  category        DoctrineCategory // Category for organization
  shortSummary    String           @db.Text // Brief summary (1-2 sentences)
  fullDescription String           @db.Text // Detailed explanation

  // Biblical foundations
  keyVerses Json // Array of {ref: string, text: string}

  // Simple, accessible explanations
  simpleExplanation   String? @db.Text // For younger teens
  discussionQuestions Json? // Array of question strings

  // Cross-references
  relatedDoctrine Json? // Array of doctrine card IDs

  // Visibility and ordering
  isPublic     Boolean @default(true) // Most doctrine cards should be public
  displayOrder Int     @default(0) // For ordering in UI

  // Metadata
  createdBy      String? // User ID (for custom org-specific cards)
  organizationId String? // NULL for global cards, set for org-specific
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  metrics DoctrineMetric[]

  @@index([category])
  @@index([organizationId])
  @@index([displayOrder])
}

enum DoctrineCategory {
  GOD // God the Father, Trinity, Attributes of God
  JESUS_CHRIST // Person of Christ, Work of Christ, Resurrection
  HOLY_SPIRIT // Person, Work, Gifts
  SCRIPTURE // Inspiration, Authority, Interpretation
  SALVATION // Grace, Faith, Repentance, Justification
  CHURCH // Body of Christ, Communion, Baptism, Church Life
  END_TIMES // Second Coming, Judgment, Heaven, Hell (non-controversial)
  HUMANITY // Creation, Sin, Image of God
  CHRISTIAN_LIVING // Prayer, Worship, Sanctification
}

model DoctrineMetric {
  id             String  @id @default(cuid())
  doctrineId     String
  organizationId String?

  // Tracking
  viewCount    Int      @default(0)
  lastViewedAt DateTime @default(now())

  // User engagement
  userId         String? // User who viewed
  featureContext String? // Where accessed (e.g., "doctrine_list", "lesson_link", "search")
  timeSpentMs    Int? // Time spent viewing

  // Lesson usage
  usedInLesson Boolean @default(false)
  lessonId     String?

  createdAt DateTime @default(now())

  doctrine DoctrineCard @relation(fields: [doctrineId], references: [id], onDelete: Cascade)

  @@index([doctrineId])
  @@index([organizationId])
  @@index([createdAt])
  @@index([userId])
}

// ============================================================================
// BIG STORY OVERVIEW (Creation â†’ New Creation)
// ============================================================================

model BigStorySection {
  id             String   @id @default(cuid())
  organizationId String

  // Section metadata
  sectionTitle   String   // "Creation", "Fall", "Redemption Begun", etc.
  sectionSlug    String   // URL-friendly: "creation", "fall", "redemption-begun"
  order          Int      // Chronological order (1, 2, 3...)
  timelineEra    String   // "Beginning", "Old Testament", "Gospels", "Church Age", "Future"

  // Content
  description    String?  @db.Text
  keyPassages    Json     // Array of {ref: string, text?: string, notes?: string, isOT: boolean}
  keyEvents      Json     // Array of strings: major biblical events in this section
  narrative      Json     // {summary: string, connections: string[], howItFits: string, nextSection?: string}

  // Visual data for timeline
  visualData     Json?    // {color: string, icon?: string, position?: number}

  // Visibility
  isPublic       Boolean  @default(false)

  // Authorship
  createdBy      String?  // User ID
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  metrics        BigStoryMetric[]

  @@unique([organizationId, sectionSlug])
  @@index([organizationId])
  @@index([order])
  @@index([sectionSlug])
}

model BigStoryMetric {
  id             String   @id @default(cuid())
  sectionId      String
  organizationId String

  // Tracking
  viewCount      Int      @default(0)
  lastViewedAt   DateTime @default(now())

  // User engagement
  userId         String?  // User who viewed
  featureContext String?  // Where it was accessed
  timeSpentMs    Int?     // Time spent viewing in milliseconds

  // Lesson usage tracking
  usedInLesson   Boolean  @default(false)
  lessonId       String?

  createdAt      DateTime @default(now())

  section BigStorySection @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@index([sectionId])
  @@index([organizationId])
  @@index([createdAt])
  @@index([userId])
}

// ============================================================================
// PERSONAL SPIRITUAL GOALS TRACKER
// ============================================================================

model PersonalGoal {
  id              String   @id @default(cuid())
  organizationId  String
  userId          String

  // Goal details
  title           String
  description     String?  @db.Text
  category        GoalCategory
  targetDate      DateTime?
  status          GoalStatus @default(IN_PROGRESS)
  priority        GoalPriority @default(MEDIUM)

  // Privacy & metadata
  isPrivate       Boolean  @default(true)
  metadata        Json?    // Flexible storage for tags, notes, custom fields

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user            User @relation(fields: [userId], references: [id], onDelete: Cascade)
  progressUpdates GoalProgress[]

  @@index([organizationId])
  @@index([userId])
  @@index([userId, status])
  @@index([category])
}

model GoalProgress {
  id          String   @id @default(cuid())
  goalId      String
  userId      String

  // Progress tracking
  note        String?  @db.Text
  progress    Int      // 0-100 percentage
  timestamp   DateTime @default(now())

  goal        PersonalGoal @relation(fields: [goalId], references: [id], onDelete: Cascade)
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([goalId])
  @@index([goalId, timestamp])
  @@index([userId])
}

enum GoalCategory {
  PRAYER
  BIBLE_READING
  SCRIPTURE_MEMORIZATION
  SERVICE
  DISCIPLESHIP
  WORSHIP
  WITNESSING
  FELLOWSHIP
  SPIRITUAL_DISCIPLINE
  CHARACTER_DEVELOPMENT
  OTHER
}

enum GoalStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  PAUSED
  ABANDONED
}

enum GoalPriority {
  LOW
  MEDIUM
  HIGH
}

// ============================================================================
// SIGNUP FUNNEL ANALYTICS
// ============================================================================

model SignupFunnelEvent {
  id             String   @id @default(cuid())
  organizationId String
  userId         String?  // NULL until account is created

  // Event tracking
  eventType      SignupEventType
  sessionId      String   // To group events from same signup session

  // Context
  userAgent      String?
  ipAddress      String?
  referralSource String?  // Where they came from (e.g., "invite_link", "direct", "social_media")

  // Metadata
  metadata       Json?    // Additional event-specific data

  // Timing
  createdAt      DateTime @default(now())

  @@index([organizationId])
  @@index([userId])
  @@index([sessionId])
  @@index([eventType])
  @@index([createdAt])
}

enum SignupEventType {
  SIGNUP_STARTED       // User visited signup page
  ACCOUNT_CREATED      // User successfully created account
  PROFILE_COMPLETED    // User completed additional profile info
  GROUP_JOINED         // User joined their first group
  FIRST_LOGIN          // User logged in for the first time
  EMAIL_VERIFIED       // User verified their email (future feature)
  ONBOARDING_COMPLETED // User completed onboarding flow
}
