// This is your Prisma schema file for Teen Sunday School
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ORGANIZATIONS & USERS
// ============================================================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  timezone  String   @default("America/New_York")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users        User[]
  groups       Group[]
  integrations ExternalIntegration[]
  lessons      Lesson[]
  aiFilterConfigs AIFilterConfig[]
  comparativeThemes ComparativeTheme[]

  @@index([slug])
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  passwordHash   String
  firstName      String
  lastName       String
  role           Role     @default(MEMBER)
  organizationId String
  isActive       Boolean  @default(true)

  // External system IDs (for syncing)
  externalId     String?  // Planning Center person ID
  externalData   Json?    // Additional metadata from external system

  lastLoginAt    DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization          Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  groupMemberships      GroupMember[]
  refreshTokens         RefreshToken[]
  notificationPreference NotificationPreference?
  notifications         Notification[]

  @@index([email])
  @@index([organizationId])
  @@index([externalId])
}

enum Role {
  SUPER_ADMIN    // Platform admin
  ORG_ADMIN      // Organization administrator
  TEACHER        // Can create/edit lessons
  MEMBER         // Regular member/student
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

// ============================================================================
// GROUPS
// ============================================================================

model Group {
  id             String   @id @default(cuid())
  name           String
  description    String?
  organizationId String

  // For syncing with external systems
  externalId     String?  // Planning Center list ID
  externalData   Json?    // Metadata from external system

  ageMin         Int?
  ageMax         Int?
  grade          String?

  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members      GroupMember[]
  mappings     ExternalGroupMapping[]
  lessons      LessonGroup[]

  @@index([organizationId])
  @@index([externalId])
}

model GroupMember {
  id        String   @id @default(cuid())
  userId    String
  groupId   String
  role      String   @default("member") // "leader", "assistant", "member"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId])
  @@index([userId])
  @@index([groupId])
}

// ============================================================================
// EXTERNAL INTEGRATIONS
// ============================================================================

model ExternalIntegration {
  id             String   @id @default(cuid())
  organizationId String
  provider       IntegrationProvider
  status         IntegrationStatus @default(INACTIVE)

  // Encrypted credentials (AES-256-GCM)
  credentialsEncrypted String   @db.Text
  credentialsIV        String   // Initialization vector for encryption
  credentialsTag       String   // Authentication tag for encryption

  // OAuth specific fields
  accessToken    String?  @db.Text
  refreshToken   String?  @db.Text
  tokenExpiresAt DateTime?

  // API configuration
  apiBaseUrl     String?
  apiVersion     String?

  // Sync configuration
  syncEnabled    Boolean  @default(false)
  syncFrequency  SyncFrequency @default(DAILY)
  lastSyncAt     DateTime?
  lastSyncStatus SyncStatus?
  nextSyncAt     DateTime?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization  Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  groupMappings ExternalGroupMapping[]
  syncLogs      SyncLog[]

  @@index([organizationId])
  @@index([provider])
  @@index([status])
}

enum IntegrationProvider {
  PLANNING_CENTER
  CCB              // Church Community Builder
  ELVANTO
  BREEZE
  FELLOWSHIP_ONE
  ROCK_RMS
}

enum IntegrationStatus {
  ACTIVE
  INACTIVE
  ERROR
  PENDING
  EXPIRED          // OAuth token expired
}

enum SyncFrequency {
  HOURLY
  DAILY
  WEEKLY
  MANUAL           // Only manual syncs
}

enum SyncStatus {
  SUCCESS
  ERROR
  PARTIAL          // Some data synced, some failed
}

// ============================================================================
// GROUP MAPPINGS
// ============================================================================

model ExternalGroupMapping {
  id                String   @id @default(cuid())
  integrationId     String
  externalGroupId   String   // ID from external system (e.g., Planning Center list ID)
  externalGroupName String
  externalGroupType String?  // Type in external system
  groupId           String?  // NULL if not yet mapped

  // Sync settings for this mapping
  syncMembers       Boolean  @default(true)
  syncLeaders       Boolean  @default(true)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  integration ExternalIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  group       Group? @relation(fields: [groupId], references: [id], onDelete: SetNull)

  @@unique([integrationId, externalGroupId])
  @@index([integrationId])
  @@index([groupId])
}

// ============================================================================
// SYNC LOGS & ANALYTICS
// ============================================================================

model SyncLog {
  id            String   @id @default(cuid())
  integrationId String
  status        SyncStatus
  startedAt     DateTime @default(now())
  completedAt   DateTime?
  durationMs    Int?     // Duration in milliseconds

  // Metrics
  peopleAdded   Int @default(0)
  peopleUpdated Int @default(0)
  peopleRemoved Int @default(0)
  groupsAdded   Int @default(0)
  groupsUpdated Int @default(0)
  groupsSkipped Int @default(0)

  // Error tracking
  errorMessage  String?  @db.Text
  errorCode     String?
  errorDetails  Json?

  // Additional metadata
  metadata      Json?

  integration ExternalIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@index([startedAt])
  @@index([status])
}

// ============================================================================
// LESSONS (Migrated from localStorage)
// ============================================================================

model Lesson {
  id             String   @id @default(cuid())
  organizationId String

  // Lesson metadata
  title          String
  quarter        Int
  unit           Int
  lessonNumber   Int
  scripture      String

  // Content
  content        Json     // Full lesson content as JSON
  slides         Json?    // Slide data
  games          Json?    // Game configurations

  // Sharing & visibility
  isPublic       Boolean  @default(false)
  isTemplate     Boolean  @default(false)

  createdBy      String?  // User ID
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  groups       LessonGroup[]

  @@unique([organizationId, quarter, unit, lessonNumber])
  @@index([organizationId])
  @@index([isPublic])
}

model LessonGroup {
  id        String   @id @default(cuid())
  lessonId  String
  groupId   String
  createdAt DateTime @default(now())

  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  group  Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([lessonId, groupId])
  @@index([lessonId])
  @@index([groupId])
}

// ============================================================================
// AI CONTENT FILTERS
// ============================================================================

model AIFilterConfig {
  id             String   @id @default(cuid())
  organizationId String?  // NULL = global/default config

  // Filter categories and their handling rules
  filterRules    Json     // { "relationships_sexuality": "REDIRECT", "mental_health": "GUIDANCE", ... }

  // Additional settings
  customKeywords Json?    // Custom keywords to filter: { "block": [...], "monitor": [...] }
  redirectMessage String? @db.Text // Custom message when redirecting to leader

  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  metrics      AIFilterMetric[]

  @@unique([organizationId]) // One config per org (plus one global)
  @@index([organizationId])
  @@index([isActive])
}

enum FilterCategory {
  RELATIONSHIPS_SEXUALITY
  MENTAL_HEALTH
  CONTROVERSIAL_DOCTRINE
  VIOLENCE_ABUSE
  SUBSTANCE_USE
  POLITICS
  FAMILY_ISSUES
  DEATH_GRIEF
  DOUBTS_FAITH
  PEER_PRESSURE
  CUSTOM
}

enum FilterAction {
  REDIRECT     // Redirect to leader
  GUIDANCE     // Provide high-level guidance only
  BLOCK        // Block completely with generic message
  MONITOR      // Allow but log for review
}

model AIFilterMetric {
  id             String   @id @default(cuid())
  filterId       String
  organizationId String?

  // Query details
  query          String   @db.Text
  detectedCategory FilterCategory
  actionTaken    FilterAction

  // Context
  userId         String?  // User who made the query
  groupId        String?  // Group context if applicable
  featureName    String?  // Which AI feature triggered the filter

  // Leader follow-up tracking
  leaderNotified Boolean  @default(false)
  leaderResponse String?  @db.Text
  resolvedAt     DateTime?

  createdAt      DateTime @default(now())

  filter AIFilterConfig @relation(fields: [filterId], references: [id], onDelete: Cascade)

  @@index([filterId])
  @@index([organizationId])
  @@index([createdAt])
  @@index([detectedCategory])
  @@index([actionTaken])
  @@index([userId])
}

// ============================================================================
// COMPARATIVE THEME VIEW (OT vs NT)
// ============================================================================

model ComparativeTheme {
  id             String   @id @default(cuid())
  organizationId String

  // Theme metadata
  themeName      String
  description    String?  @db.Text
  category       String?  // e.g., "covenant", "sacrifice", "grace", "justice"

  // Old Testament passages
  otPassages     Json     // Array of {ref: string, text?: string, notes?: string}

  // New Testament passages
  ntPassages     Json     // Array of {ref: string, text?: string, notes?: string}

  // Comparative analysis
  themeNotes     Json?    // {summary: string, connections: string[], keyInsights: string[]}

  // Visibility
  isPublic       Boolean  @default(false)

  // Authorship
  createdBy      String?  // User ID
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  metrics      ThemeMetric[]

  @@index([organizationId])
  @@index([category])
  @@index([themeName])
}

model ThemeMetric {
  id             String   @id @default(cuid())
  themeId        String
  organizationId String

  // Tracking
  viewCount      Int      @default(0)
  lastViewedAt   DateTime @default(now())

  // User engagement
  userId         String?  // User who viewed
  featureContext String?  // Where it was accessed (e.g., "topical_index", "passage_link", "direct")
  timeSpentMs    Int?     // Time spent viewing in milliseconds

  // Lesson usage tracking
  usedInLesson   Boolean  @default(false)
  lessonId       String?

  createdAt      DateTime @default(now())

  theme ComparativeTheme @relation(fields: [themeId], references: [id], onDelete: Cascade)

  @@index([themeId])
  @@index([organizationId])
  @@index([createdAt])
  @@index([userId])
}

// ============================================================================
// NOTIFICATION SYSTEM
// ============================================================================

model NotificationPreference {
  id     String @id @default(cuid())
  userId String @unique

  // Email notification settings
  emailEnabled          Boolean @default(true)
  emailLessonReminders  Boolean @default(true)
  emailEventReminders   Boolean @default(true)
  emailAnnouncements    Boolean @default(true)
  emailGroupUpdates     Boolean @default(true)
  emailDigest           Boolean @default(false)  // Daily/weekly digest
  emailDigestFrequency  DigestFrequency @default(WEEKLY)

  // In-app notification settings
  inAppEnabled          Boolean @default(true)
  inAppLessonReminders  Boolean @default(true)
  inAppEventReminders   Boolean @default(true)
  inAppAnnouncements    Boolean @default(true)
  inAppGroupUpdates     Boolean @default(true)

  // Scheduling preferences
  quietHoursEnabled     Boolean @default(false)
  quietHoursStart       String? // Time in HH:MM format (e.g., "22:00")
  quietHoursEnd         String? // Time in HH:MM format (e.g., "08:00")
  quietHoursTimezone    String  @default("America/New_York")

  // Days of week preferences (ISO 8601: 1=Monday, 7=Sunday)
  preferredDays         Json?   // Array of day numbers [1,2,3,4,5] for Mon-Fri

  // Notification timing
  lessonReminderDays    Int     @default(2)  // Days before lesson to send reminder
  lessonReminderTime    String  @default("18:00") // Time to send lesson reminders (HH:MM)
  eventReminderHours    Int     @default(24) // Hours before event to send reminder

  // Batch settings
  batchNotifications    Boolean @default(false) // Batch multiple notifications together
  maxNotificationsPerDay Int    @default(10)   // Maximum notifications per day (0 = unlimited)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum DigestFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
}

model Notification {
  id             String   @id @default(cuid())
  userId         String
  organizationId String

  // Notification content
  type           NotificationType
  title          String
  message        String   @db.Text
  actionUrl      String?  // Deep link or URL for the notification action

  // Delivery settings
  deliveryMethod NotificationDeliveryMethod @default(BOTH)
  priority       NotificationPriority @default(NORMAL)

  // Scheduling
  scheduledFor   DateTime?  // When to send (NULL = send immediately)
  sentAt         DateTime?
  readAt         DateTime?

  // Status tracking
  status         NotificationStatus @default(PENDING)
  deliveryStatus Json?      // { email: "sent", inApp: "delivered" } with timestamps

  // Error handling
  failureReason  String?    @db.Text
  retryCount     Int        @default(0)
  maxRetries     Int        @default(3)

  // Related entities
  groupId        String?
  lessonId       String?
  eventId        String?

  // Metadata
  metadata       Json?      // Additional context data

  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
  @@index([status])
  @@index([type])
  @@index([scheduledFor])
  @@index([sentAt])
}

enum NotificationType {
  LESSON_REMINDER       // Upcoming lesson reminder
  EVENT_REMINDER        // Event reminder
  ANNOUNCEMENT          // General announcement
  GROUP_UPDATE          // Group membership or activity update
  LESSON_ASSIGNED       // New lesson assigned to group
  COMMENT_REPLY         // Someone replied to your comment
  MENTION               // Someone mentioned you
  SYNC_COMPLETE         // Integration sync completed
  SYNC_ERROR            // Integration sync failed
  CUSTOM                // Custom notification
}

enum NotificationDeliveryMethod {
  EMAIL
  IN_APP
  BOTH
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum NotificationStatus {
  PENDING           // Not yet sent
  SCHEDULED         // Scheduled for future delivery
  SENDING           // Currently being sent
  SENT              // Successfully sent
  DELIVERED         // Confirmed delivered (for in-app)
  READ              // User has read the notification
  FAILED            // Failed to send
  CANCELLED         // Cancelled before sending
}

model NotificationSchedule {
  id             String   @id @default(cuid())
  organizationId String
  groupId        String?  // NULL = applies to all groups in org

  // Schedule metadata
  name           String
  description    String?  @db.Text

  // Notification template
  notificationType NotificationType
  title          String
  message        String   @db.Text
  actionUrl      String?

  // Recurrence settings
  frequency      ScheduleFrequency
  dayOfWeek      Int?     // 1-7 (Monday-Sunday) for WEEKLY
  dayOfMonth     Int?     // 1-31 for MONTHLY
  timeOfDay      String   // HH:MM format (e.g., "18:00")
  timezone       String   @default("America/New_York")

  // Offset settings
  offsetDays     Int      @default(0)  // Days before/after the trigger event
  offsetHours    Int      @default(0)  // Additional hours offset

  // Targeting
  targetRoles    Json?    // Array of roles to notify ["TEACHER", "ORG_ADMIN"]
  targetUserIds  Json?    // Specific user IDs to notify

  // Status
  isActive       Boolean  @default(true)
  lastRunAt      DateTime?
  nextRunAt      DateTime?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
  @@index([groupId])
  @@index([isActive])
  @@index([nextRunAt])
}

enum ScheduleFrequency {
  ONCE          // One-time scheduled notification
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  BEFORE_LESSON // Triggered before lessons (uses offsetDays)
  BEFORE_EVENT  // Triggered before events (uses offsetHours)
}

// ============================================================================
// BIBLE CHARACTER GUESS GAME METRICS
// ============================================================================

model CharacterGuessAttempt {
  id             String   @id @default(cuid())
  userId         String?  // Optional - can track anonymous plays
  organizationId String?
  lessonId       String?

  // Game details
  characterId    String   // Character ID from lesson JSON
  characterName  String   // Character name for easier queries
  difficulty     String   // easy, medium, hard

  // Attempt details
  hintsRevealed  Int      // Number of hints revealed before guess
  isCorrect      Boolean  // Whether they guessed correctly
  attempts       Int      // Number of attempts made
  timeSpentMs    Int?     // Time spent on this character (optional)

  // Context
  mode           String   @default("solo") // solo or group
  groupId        String?  // If played in group mode

  createdAt      DateTime @default(now())

  @@index([userId])
  @@index([organizationId])
  @@index([characterId])
  @@index([lessonId])
  @@index([createdAt])
  @@index([isCorrect])
}

model CharacterGuessMetric {
  id             String   @id @default(cuid())
  characterId    String   // Character ID from lesson JSON
  characterName  String   // Character name
  organizationId String?
  lessonId       String?

  // Aggregated metrics
  totalPlays     Int      @default(0)
  totalCorrect   Int      @default(0)
  totalIncorrect Int      @default(0)
  successRate    Float    @default(0) // Calculated: totalCorrect / totalPlays

  // Hint usage statistics
  avgHintsUsed   Float    @default(0)

  // Popularity
  popularityScore Float   @default(0) // Weighted score based on plays and success

  lastPlayedAt   DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([characterId, organizationId, lessonId])
  @@index([organizationId])
  @@index([lessonId])
  @@index([popularityScore])
  @@index([successRate])
}
